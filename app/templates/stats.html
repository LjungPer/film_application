{% extends "base.html" %}
{% block content %}
    <h1>Stats for user {{ username }}</h1>
    <div><p>User {{ username }} has {{ num_pages }} pages of ratings.</p></div>
    <a href="https://letterboxd.com/kattihatt2/" class="circle">
	    <img height="128" width="128" src={{ avatar_url }}>
    </a>
    <div><p>A simple app where you provide your letterboxd username, and we provide you with some data.</p></div>

    <div id="buttons">
       <button class="action_btn" onclick='topDirectorsButton()'>Top directors</button>
        <form action="" method="post" novalidate>
        {{ form.hidden_tag() }}
        <p>{{ form.submit() }}</p>
    </form>
    </div>
    <p id="loading_text"></p>
    <div id="directors" style="text-align:center"></div>
    <div id="countries" style="text-align:center"></div>

    <script>

        // function to create table html from json
        var createDirectorsTableFromJson = function(data, title) {
            var table = document.createElement("table");
            

            const titles = [title, "Average", "Biased", "#films"];
            var tr = table.insertRow();
            for (var k = 0; k < titles.length; k++) {
                var cell = tr.insertCell();
                cell.innerHTML = titles[k];
                cell.style.fontWeight = 'bold';
            }
            
            for (var i = 0; i < data.length; i++) {
                var tr = table.insertRow();

                for (var j = 0; j < titles.length; j++) {
                    var cell = tr.insertCell();
                    cell.innerHTML = data[i][j]; // 0: name, 1: average rating, 2: biased rating, 3: nr films 
                }
            }

            table.className = "aClassName";
            return table;
        }

        var createCountriesTableFromJson = function(data) {
            var table = document.createElement("table");
            

            const titles = ["Country", "Average", "Biased", "#films"];
            var tr = table.insertRow();
            for (var k = 0; k < titles.length; k++) {
                var cell = tr.insertCell();
                cell.innerHTML = titles[k];
                cell.style.fontWeight = 'bold';
            }
            
            for (var i = 0; i < data.length; i++) {
                var tr = table.insertRow();

                for (var j = 0; j < titles.length; j++) {
                    var cell = tr.insertCell();
                    cell.innerHTML = data[i][j]; // 0: name, 1: average rating, 2: biased rating, 3: nr films 
                }
            }

            table.className = "aClassName";
            return table;
        }

        var fetchDirectors = function() {
            console.log("fetching directors data");
            $.ajax({
                type: "GET",
                url: "/directors"
            }).done(function(jsonData) {
                console.log("success ");
                $("#loading_text").hide();
                var table = createDirectorsTableFromJson(jsonData);
                var div = document.getElementById("directors");
                div.innerHTML = "";
                div.appendChild(table);
            }).fail(function() {
                console.log("failed")
            });
        }

        var fetchCountries = function() {
            console.log("fetching countries data");
            $.ajax({
                type: "GET",
                url: "/countries"
            }).done(function(jsonData) {
                console.log("success ");
                $("#loading_text").hide();
                var table = createCountriesTableFromJson(jsonData);
                var div = document.getElementById("countries");
                div.innerHTML = "";
                div.appendChild(table);
            }).fail(function() {
                console.log("failed")
            });
        }

        function topDirectorsButton() {
            var p = document.getElementById("loading_text");
            p.textContent = "Loading";
            fetchDirectors();
            fetchCountries();
        }

    </script>

{% endblock %}